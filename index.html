<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>המונופול הקיבוצי</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .board-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .board {
            display: grid;
            width: 700px;
            height: 700px;
            grid-template-columns: 100px repeat(5, 1fr) 100px;
            grid-template-rows: 100px repeat(5, 1fr) 100px;
            gap: 0;
            border: 4px solid #2e7d32;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .square {
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 3px;
            border: 1px solid #2e7d32;
        }
        
        .square:hover {
            background: #e6f3ff;
        }
        
        /* הגריד התוקן - מיקומים נכונים לכל 24 המשבצות */
        #square-0 { grid-column: 1; grid-row: 7; }   /* שער הקיבוץ - START */
        #square-1 { grid-column: 2; grid-row: 7; }
        #square-2 { grid-column: 3; grid-row: 7; }
        #square-3 { grid-column: 4; grid-row: 7; }
        #square-4 { grid-column: 5; grid-row: 7; }
        #square-5 { grid-column: 6; grid-row: 7; }
        #square-6 { grid-column: 7; grid-row: 7; }   /* מקלט - CORNER */
        #square-7 { grid-column: 7; grid-row: 6; }
        #square-8 { grid-column: 7; grid-row: 5; }
        #square-9 { grid-column: 7; grid-row: 4; }
        #square-10 { grid-column: 7; grid-row: 3; }
        #square-11 { grid-column: 7; grid-row: 2; }
        #square-12 { grid-column: 7; grid-row: 1; }  /* העץ הקסום - CORNER */
        #square-13 { grid-column: 6; grid-row: 1; }
        #square-14 { grid-column: 5; grid-row: 1; }
        #square-15 { grid-column: 4; grid-row: 1; }
        #square-16 { grid-column: 3; grid-row: 1; }
        #square-17 { grid-column: 2; grid-row: 1; }
        #square-18 { grid-column: 1; grid-row: 1; }  /* תורנות שמירה - CORNER */
        #square-19 { grid-column: 1; grid-row: 2; }
        #square-20 { grid-column: 1; grid-row: 3; }
        #square-21 { grid-column: 1; grid-row: 4; }
        #square-22 { grid-column: 1; grid-row: 5; }
        #square-23 { grid-column: 1; grid-row: 6; }
        
        /* סוגי משבצות */
        .corner {
            background: linear-gradient(135deg, #ffd700, #ffed4a) !important;
            font-weight: bold;
            font-size: 10px;
            border: 3px solid #f39c12 !important;
        }
        
        .property {
            background: #e3f2fd;
            border-top: 12px solid #2196f3 !important;
        }
        
        .public-property {
            background: #f3e5f5;
            border-top: 12px solid #9c27b0 !important;
        }
        
        .special-property {
            background: #fff3e0;
            border-top: 12px solid #ff9800 !important;
        }
        
        .tax {
            background: #ffebee;
            border-top: 12px solid #f44336 !important;
            color: #d32f2f;
        }
        
        .card-space {
            background: #e8f5e8;
            border-top: 12px solid #4caf50 !important;
        }
        
        /* גבולות צבעוניים לעמודות צידיות */
        .left-tile.property { border-top: none !important; border-right: 12px solid #2196f3 !important; }
        .left-tile.special-property { border-top: none !important; border-right: 12px solid #ff9800 !important; }
        .left-tile.card-space { border-top: none !important; border-right: 12px solid #4caf50 !important; }
        .left-tile.public-property { border-top: none !important; border-right: 12px solid #9c27b0 !important; }
        .left-tile.tax { border-top: none !important; border-right: 12px solid #f44336 !important; }
        
        .right-tile.property { border-top: none !important; border-left: 12px solid #2196f3 !important; }
        .right-tile.special-property { border-top: none !important; border-left: 12px solid #ff9800 !important; }
        .right-tile.card-space { border-top: none !important; border-left: 12px solid #4caf50 !important; }
        .right-tile.public-property { border-top: none !important; border-left: 12px solid #9c27b0 !important; }
        .right-tile.tax { border-top: none !important; border-left: 12px solid #f44336 !important; }
        
        /* אזור האמצע */
        .center-area {
            grid-column: 2 / 7;
            grid-row: 2 / 7;
            background: #c8e6c9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-direction: column;
        }
        
        .game-title {
            font-size: 20px;
            font-weight: bold;
            color: #2e7d32;
            text-align: center;
            transform: rotate(-15deg);
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #f39c12;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .card-decks {
            display: flex;
            gap: 20px;
        }
        
        .card-deck {
            width: 70px;
            height: 50px;
            background: #fff;
            border: 2px solid #2e7d32;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: #2e7d32;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .card-deck:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .card-deck.community {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-color: #ef6c00;
        }
        
        .card-deck.kibbutz {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
            border-color: #0d47a1;
        }
        
        .player-token {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            border: 2px solid #333;
            transition: all 0.3s ease;
            z-index: 10;
            font-weight: bold;
        }
        
        .token-0 { background: #ff4757; color: white; }
        .token-1 { background: #2ed573; color: white; }
        .token-2 { background: #3742fa; color: white; }
        .token-3 { background: #ffa502; color: white; }
        
        .game-info {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px;
            min-width: 300px;
            height: fit-content;
        }
        
        .player-info {
            background: #f8f9fa;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .player-info.current-player {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .dice-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .dice {
            display: inline-block;
            margin: 0 10px;
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            font-size: 24px;
            text-align: center;
            line-height: 36px;
            font-weight: bold;
        }
        
        .roll-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .roll-button:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .roll-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .setup-screen {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .setup-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .setup-button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .property-price {
            font-size: 6px;
            color: #666;
            margin-top: 1px;
        }
        
        .owned-property {
            background: #fff59d !important;
            border: 2px solid #ff9800 !important;
        }
    </style>
</head>
<body>
    <!-- מסך התחלה -->
    <div id="setup" class="setup-screen">
        <h1>🏘️ המונופול הקיבוצי 🏘️</h1>
        <h2>בחר מספר שחקנים:</h2>
        <button class="setup-button" onclick="startGame(2)">2 שחקנים</button>
        <button class="setup-button" onclick="startGame(4)">4 שחקנים</button>
    </div>

    <!-- משחק -->
    <div id="game" class="game-container" style="display: none;">
        <div class="board-container">
            <div class="board" id="board">
                <!-- אזור האמצע -->
                <div class="center-area">
                    <div class="game-title">המונופול הקיבוצי</div>
                    <div class="card-decks">
                        <div class="card-deck community" onclick="showDeckInfo('community')">
                            <div>🏘️</div>
                            <div>קהילה</div>
                        </div>
                        <div class="card-deck kibbutz" onclick="showDeckInfo('kibbutz')">
                            <div>🏛️</div>
                            <div>שיחת קיבוץ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="game-info">
            <h2>מידע משחק</h2>
            <div id="current-turn">תור שחקן 1</div>
            
            <div class="dice-container">
                <div class="dice" id="dice1">1</div>
                <div class="dice" id="dice2">1</div>
                <br>
                <button class="roll-button" id="roll-btn" onclick="rollDice()">זרוק קוביות</button>
            </div>
            
            <div id="players-info"></div>
            <div id="game-log"></div>
        </div>
    </div>

    <!-- חלון קלפים -->
    <div id="card-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCard()">&times;</span>
            <h3 id="card-title"></h3>
            <p id="card-text"></p>
            <button class="setup-button" onclick="closeCard()">סגור</button>
        </div>
    </div>

    <!-- חלון קנייה -->
    <div id="buy-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBuyModal()">&times;</span>
            <h3 id="buy-title"></h3>
            <p id="buy-text"></p>
            <button class="setup-button" onclick="buyProperty()">קנה</button>
            <button class="setup-button" onclick="closeBuyModal()">דלג</button>
        </div>
    </div>

    <script>
        // משתנים גלובליים
        let gameState = {
            players: [],
            currentPlayer: 0,
            numPlayers: 0,
            board: [],
            communityCards: [],
            kibbutzCards: [],
            communityDeck: [],
            kibbutzDeck: [],
            gameStarted: false
        };

        // נתוני הלוח - כל 24 המשבצות החדשות
        const boardData = [
            {id: 1, name: "שער הקיבוץ", type: "פינה", special: "start"},
            {id: 2, name: "שביל הותיקים", type: "נכס", price: 60, rent: 6},
            {id: 3, name: "קומותיים", type: "נכס", price: 80, rent: 8},
            {id: 4, name: "קהילה", type: "קלף", cardType: "community"},
            {id: 5, name: "דירת יורשים אמצעית", type: "נכס", price: 100, rent: 15},
            {id: 6, name: "דירת יורשים פינתית", type: "נכס", price: 120, rent: 20}, // NEW
            {id: 7, name: "מקלט", type: "פינה", special: "jail"},
            {id: 8, name: "מיסי קהילה", type: "מיסים", tax: 100},
            {id: 9, name: "רפת", type: "נכס מיוחד", rule: "שכירות לפי קובייה", price: 150},
            {id: 10, name: "שיחת קיבוץ", type: "קלף", cardType: "kibbutz"},
            {id: 11, name: "בנה בתך", type: "נכס", price: 150, rent: 25},
            {id: 12, name: "MCP", type: "נכס מיוחד", rule: "שכירות לפי קובייה", price: 180}, // NEW
            {id: 13, name: "העץ הקסום", type: "פינה", special: "parking"},
            {id: 14, name: "הרחבה עם שטח ציבורי", type: "נכס", price: 180, rent: 35},
            {id: 15, name: "מטע אבוקדו", type: "נכס מיוחד", rule: "שכירות לפי קובייה", price: 200},
            {id: 16, name: "כלבו", type: "נכס ציבורי", price: 220, rent: 50},
            {id: 17, name: "קהילה", type: "קלף", cardType: "community"},
            {id: 18, name: "פאב הערובה", type: "נכס", price: 180, rent: 40}, // NEW
            {id: 19, name: "תורנות שמירה", type: "פינה", rule: "לך לשער הקיבוץ", special: "gotojail"},
            {id: 20, name: "מועדון לחבר", type: "נכס", price: 250, rent: 45}, // NEW
            {id: 21, name: "גן שעשועים", type: "נכס ציבורי", price: 200, rent: 45},
            {id: 22, name: "שיחת קיבוץ", type: "קלף", cardType: "kibbutz"},
            {id: 23, name: "בריכה", type: "נכס ציבורי", price: 240, rent: 60},
            {id: 24, name: "מועדון לחבר פרמיום", type: "נכס", price: 280, rent: 50}
        ];

        // קלפי קהילה
        const communityCardsData = [
            {text: "נתפסת גונב מעדן חלב מהכולבו – שלם 100 ₪", action: "pay", amount: 100},
            {text: "רחפן תפס אותך לא אוסף קקי – שלם 50 ₪", action: "pay", amount: 50},
            {text: "שבת חתן בבריכה – קבל 150 ₪", action: "receive", amount: 150},
            {text: "מתנות סוף שנה לגננות – שלם 100 ₪", action: "pay", amount: 100},
            {text: "גניבת מנגו מתועדת – שלם 50 ₪ לכל שחקן", action: "payAll", amount: 50},
            {text: "ערב שירה בציבור – קבל 100 ₪", action: "receive", amount: 100},
            {text: "נפטרת מחפצים בקבוצת יד 2 – קבל 50 ₪", action: "receive", amount: 50},
            {text: "המציל תפס את הילד בעמוקים – שלם 100 ₪", action: "pay", amount: 100},
            {text: "גררת את סבתא לכלבו – קבל 100 ₪ והתקדם ל\"כלבו\"", action: "moveAndReceive", target: 15, amount: 100},
            {text: "עברת ליד הגן של הילד – חזור 3 משבצות אחורה", action: "moveBack", amount: 3},
            {text: "קיבלת מינוי אדמין – כל שחקן משלם לך 50 ₪", action: "receiveFromAll", amount: 50}
        ];

        // קלפי שיחת קיבוץ
        const kibbutzCardsData = [
            {text: "חוק השיוך עבר – עד גיל 18 שלם 300 ₪, מעל גיל 18 שלם 50 ₪", action: "pay", amount: 50},
            {text: "מועצה הטילה מס שקר כלשהו – אם יש לך נכס פרטי שלם 150 ₪", action: "payIfOwns", amount: 150},
            {text: "ועדת תכנון שוב שינתה את שביל הוותיקים – שלם 150 ₪", action: "pay", amount: 150},
            {text: "השתתפת בשיחת קיבוץ ארוכה – דלג על תור אחד", action: "skipTurn", amount: 0},
            {text: "נמצא חוב בן 80 שנה – שלם 120 ₪", action: "pay", amount: 120},
            {text: "הוזמנת לישיבת חירום – התקדם ל\"מועדון לחבר\"", action: "moveTo", target: 19},
            {text: "עברו שנה ועדיין אין מקלטים – שלם 50 ₪", action: "pay", amount: 50},
            {text: "הוועד הסכים איתך – התקדם לבריכה וקבל 50 ₪", action: "moveAndReceive", target: 22, amount: 50}
        ];

        // אתחול המשחק
        function startGame(numPlayers) {
            gameState.numPlayers = numPlayers;
            gameState.gameStarted = true;
            
            const tokens = ['🎩', '🚲', '🛺', '🚜'];
            for (let i = 0; i < numPlayers; i++) {
                gameState.players.push({
                    id: i,
                    name: `שחקן ${i + 1}`,
                    money: 750,
                    position: 0,
                    properties: [],
                    token: tokens[i],
                    skipTurn: false
                });
            }
            
            gameState.board = [...boardData];
            gameState.communityCards = [...communityCardsData];
            gameState.kibbutzCards = [...kibbutzCardsData];
            gameState.communityDeck = [...communityCardsData];
            gameState.kibbutzDeck = [...kibbutzCardsData];
            
            shuffleDeck(gameState.communityDeck);
            shuffleDeck(gameState.kibbutzDeck);
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'flex';
            
            createBoard();
            createPlayers();
            updateDisplay();
        }

        function createBoard() {
            const board = document.getElementById('board');
            
            gameState.board.forEach((square, index) => {
                const squareEl = document.createElement('div');
                let className = 'square ';
                
                // הוספת classes לצדדים
                if ([18,19,20,21,22,23].includes(index)) {
                    className += 'left-tile ';
                }
                if ([7,8,9,10,11].includes(index)) {
                    className += 'right-tile ';
                }
                
                switch (square.type) {
                    case 'פינה':
                        className += 'corner';
                        break;
                    case 'נכס':
                        className += 'property';
                        break;
                    case 'נכס ציבורי':
                        className += 'public-property';
                        break;
                    case 'נכס מיוחד':
                        className += 'special-property';
                        break;
                    case 'מיסים':
                        className += 'tax';
                        break;
                    case 'קלף':
                        className += 'card-space';
                        break;
                }
                
                squareEl.className = className;
                squareEl.id = `square-${index}`;
                
                let content = `<div style="font-weight: bold; margin-bottom: 1px; font-size: 7px;">${square.name}</div>`;
                
                if (square.price > 0) {
                    content += `<div class="property-price">₪${square.price}</div>`;
                }
                if (square.rent > 0) {
                    content += `<div class="property-price">שכירות: ₪${square.rent}</div>`;
                }
                if (square.tax > 0) {
                    content += `<div class="property-price">מס: ₪${square.tax}</div>`;
                }
                if (square.rule) {
                    content += `<div class="property-price">${square.rule}</div>`;
                }
                
                squareEl.innerHTML = content;
                board.appendChild(squareEl);
            });
        }

        function createPlayers() {
            gameState.players.forEach((player, index) => {
                const token = document.createElement('div');
                token.className = `player-token token-${index}`;
                token.id = `token-${index}`;
                token.textContent = player.token;
                
                positionToken(index, 0);
                
                document.getElementById('board').appendChild(token);
            });
        }

        function positionToken(playerIndex, squareIndex) {
            const token = document.getElementById(`token-${playerIndex}`);
            const square = document.getElementById(`square-${squareIndex}`);
            
            if (!token || !square) return;
            
            const squareRect = square.getBoundingClientRect();
            const boardRect = document.getElementById('board').getBoundingClientRect();
            
            const offsetX = (playerIndex % 2) * 26;
            const offsetY = Math.floor(playerIndex / 2) * 26;
            
            token.style.left = (squareRect.left - boardRect.left + offsetX + 5) + 'px';
            token.style.top = (squareRect.top - boardRect.top + offsetY + 5) + 'px';
        }

        function showDeckInfo(type) {
            const deckSize = type === 'community' ? gameState.communityDeck.length : gameState.kibbutzDeck.length;
            const deckName = type === 'community' ? 'קהילה' : 'שיחת קיבוץ';
            alert(`ערמת ${deckName}\nנשארו ${deckSize} קלפים`);
        }

        function rollDice() {
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;
            
            document.getElementById('dice1').textContent = dice1;
            document.getElementById('dice2').textContent = dice2;
            document.getElementById('roll-btn').disabled = true;
            
            addLog(`${gameState.players[gameState.currentPlayer].name} זרק ${dice1} + ${dice2} = ${total}`);
            
            setTimeout(() => {
                movePlayer(total);
                setTimeout(() => {
                    handleSquare();
                }, 1000);
            }, 1000);
        }

        function movePlayer(steps) {
            const player = gameState.players[gameState.currentPlayer];
            const oldPosition = player.position;
            player.position = (player.position + steps) % 24; // Updated for 24 tiles
            
            if (player.position < oldPosition) {
                player.money += 100;
                addLog(`${player.name} עבר בשער הקיבוץ וקיבל 100 ₪`);
            }
            
            positionToken(gameState.currentPlayer, player.position);
            updateDisplay();
            
            addLog(`${player.name} הגיע למשבצת: ${gameState.board[player.position].name}`);
        }

        function handleSquare() {
            const player = gameState.players[gameState.currentPlayer];
            const square = gameState.board[player.position];
            
            switch (square.type) {
                case 'נכס':
                case 'נכס ציבורי':
                    handleProperty(square, player.position);
                    break;
                case 'נכס מיוחד':
                    handleSpecialProperty(square, player.position);
                    break;
                case 'קלף':
                    drawCard(square.cardType);
                    break;
                case 'מיסים':
                    handleTax(square);
                    break;
                case 'פינה':
                    handleCorner(square);
                    break;
                default:
                    nextTurn();
                    break;
            }
        }

        function handleProperty(square, squareIndex) {
            const player = gameState.players[gameState.currentPlayer];
            const owner = findPropertyOwner(squareIndex);
            
            if (!owner) {
                showBuyModal(square, squareIndex);
            } else if (owner.id !== player.id) {
                let rent = square.rent;
                
                // בדיקת בונוס דירות יורשים
                const apartments = [1, 4, 5]; // דירת יורשים אמצעית ופינתית
                if (apartments.every(pos => findPropertyOwner(pos) && findPropertyOwner(pos).id === owner.id)) {
                    rent *= 2;
                    addLog(`שכירות מוכפלת כי ${owner.name} מחזיק בכל הדירות!`);
                }
                
                payRent(player, owner, rent);
                nextTurn();
            } else {
                nextTurn();
            }
        }

        function handleSpecialProperty(square, squareIndex) {
            const player = gameState.players[gameState.currentPlayer];
            const owner = findPropertyOwner(squareIndex);
            
            if (!owner) {
                showBuyModal(square, squareIndex);
            } else if (owner.id !== player.id) {
                const dice = Math.floor(Math.random() * 6) + 1;
                let rent;
                
                if (dice <= 2) rent = 10;
                else if (dice <= 4) rent = 20;
                else if (dice === 5) rent = 30;
                else rent = 50;
                
                // בדיקת בונוס נכסים מיוחדים
                const specialProps = [8, 11, 14]; // רפת, MCP, מטע אבוקדו
                const ownedSpecials = specialProps.filter(pos => findPropertyOwner(pos) && findPropertyOwner(pos).id === owner.id);
                if (ownedSpecials.length >= 2) {
                    rent *= 2;
                    addLog(`שכירות מוכפלת כי ${owner.name} מחזיק בנכסים מיוחדים!`);
                }
                
                addLog(`נזרקה ${dice} על הקובייה - שכירות: ${rent} ₪`);
                payRent(player, owner, rent);
                nextTurn();
            } else {
                nextTurn();
            }
        }

        function findPropertyOwner(squareIndex) {
            for (let player of gameState.players) {
                if (player.properties.includes(squareIndex)) {
                    return player;
                }
            }
            return null;
        }

        function payRent(payer, owner, amount) {
            payer.money -= amount;
            owner.money += amount;
            addLog(`${payer.name} שילם ${amount} ₪ שכירות ל${owner.name}`);
            checkBankruptcy(payer);
            updateDisplay();
        }

        function showBuyModal(square, squareIndex) {
            document.getElementById('buy-title').textContent = square.name;
            document.getElementById('buy-text').textContent = `מחיר: ${square.price} ₪${square.rent ? `\nשכירות: ${square.rent} ₪` : ''}${square.rule ? `\n${square.rule}` : ''}`;
            document.getElementById('buy-modal').style.display = 'block';
            window.currentPurchase = {square, squareIndex};
        }

        function buyProperty() {
            const player = gameState.players[gameState.currentPlayer];
            const {square, squareIndex} = window.currentPurchase;
            
            if (player.money >= square.price) {
                player.money -= square.price;
                player.properties.push(squareIndex);
                document.getElementById(`square-${squareIndex}`).classList.add('owned-property');
                addLog(`${player.name} קנה את ${square.name} ב-${square.price} ₪`);
            } else {
                addLog(`ל${player.name} אין מספיק כסף לקנות את ${square.name}`);
            }
            
            closeBuyModal();
            updateDisplay();
            nextTurn();
        }

        function closeBuyModal() {
            document.getElementById('buy-modal').style.display = 'none';
        }

        function drawCard(type) {
            let deck = type === 'community' ? gameState.communityDeck : gameState.kibbutzDeck;
            let cards = type === 'community' ? gameState.communityCards : gameState.kibbutzCards;
            
            if (deck.length === 0) {
                deck = [...cards];
                shuffleDeck(deck);
                if (type === 'community') gameState.communityDeck = deck;
                else gameState.kibbutzDeck = deck;
            }
            
            const card = deck.pop();
            showCard(card, type);
        }

        function showCard(card, type) {
            document.getElementById('card-title').textContent = type === 'community' ? 'קהילה' : 'שיחת קיבוץ';
            document.getElementById('card-text').textContent = card.text;
            document.getElementById('card-modal').style.display = 'block';
            window.currentCard = card;
        }

        function closeCard() {
            document.getElementById('card-modal').style.display = 'none';
            if (window.currentCard) {
                executeCardAction(window.currentCard);
                window.currentCard = null;
            }
            setTimeout(() => nextTurn(), 500);
        }

        function executeCardAction(card) {
            const player = gameState.players[gameState.currentPlayer];
            
            switch (card.action) {
                case 'pay':
                    player.money -= card.amount;
                    addLog(`${player.name} שילם ${card.amount} ₪`);
                    break;
                case 'receive':
                    player.money += card.amount;
                    addLog(`${player.name} קיבל ${card.amount} ₪`);
                    break;
                case 'payAll':
                    gameState.players.forEach(p => {
                        if (p.id !== player.id) {
                            player.money -= card.amount;
                            p.money += card.amount;
                        }
                    });
                    addLog(`${player.name} שילם ${card.amount} ₪ לכל שחקן`);
                    break;
                case 'receiveFromAll':
                    gameState.players.forEach(p => {
                        if (p.id !== player.id) {
                            p.money -= card.amount;
                            player.money += card.amount;
                        }
                    });
                    addLog(`${player.name} קיבל ${card.amount} ₪ מכל שחקן`);
                    break;
                case 'skipTurn':
                    player.skipTurn = true;
                    addLog(`${player.name} ידלג על התור הבא`);
                    break;
                case 'moveTo':
                    player.position = card.target;
                    positionToken(gameState.currentPlayer, player.position);
                    addLog(`${player.name} עבר למשבצת ${gameState.board[card.target].name}`);
                    break;
                case 'moveAndReceive':
                    player.position = card.target;
                    player.money += card.amount;
                    positionToken(gameState.currentPlayer, player.position);
                    addLog(`${player.name} עבר למשבצת ${gameState.board[card.target].name} וקיבל ${card.amount} ₪`);
                    break;
                case 'moveBack':
                    player.position = (player.position - card.amount + 24) % 24;
                    positionToken(gameState.currentPlayer, player.position);
                    addLog(`${player.name} חזר ${card.amount} משבצות אחורה`);
                    break;
                case 'payIfOwns':
                    if (player.properties.length > 0) {
                        player.money -= card.amount;
                        addLog(`${player.name} שילם ${card.amount} ₪ כי יש לו נכסים`);
                    }
                    break;
            }
            
            checkBankruptcy(player);
            updateDisplay();
        }

        function handleTax(square) {
            const player = gameState.players[gameState.currentPlayer];
            player.money -= square.tax;
            addLog(`${player.name} שילם ${square.tax} ₪ מס`);
            checkBankruptcy(player);
            updateDisplay();
            nextTurn();
        }

        function handleCorner(square) {
            const player = gameState.players[gameState.currentPlayer];
            
            switch (square.special) {
                case 'start':
                    addLog(`${player.name} נחת על שער הקיבוץ`);
                    break;
                case 'jail':
                    addLog(`${player.name} מבקר במקלט`);
                    break;
                case 'parking':
                    addLog(`${player.name} נחת על העץ הקסום`);
                    break;
                case 'gotojail':
                    player.position = 0;
                    positionToken(gameState.currentPlayer, 0);
                    addLog(`${player.name} נשלח בתורנות שמירה וחוזר לשער הקיבוץ`);
                    break;
            }
            
            nextTurn();
        }

        function checkBankruptcy(player) {
            if (player.money <= 0) {
                addLog(`${player.name} פשט רגל ויצא מהמשחק!`);
                
                player.properties.forEach(propIndex => {
                    document.getElementById(`square-${propIndex}`).classList.remove('owned-property');
                });
                
                const playerIndex = gameState.players.findIndex(p => p.id === player.id);
                gameState.players.splice(playerIndex, 1);
                
                if (gameState.currentPlayer >= gameState.players.length) {
                    gameState.currentPlayer = 0;
                }
                
                if (gameState.players.length === 1) {
                    endGame();
                    return;
                }
                
                document.getElementById(`token-${player.id}`).style.display = 'none';
            }
        }

        function nextTurn() {
            if (gameState.players.length === 0) return;
            
            if (gameState.players[gameState.currentPlayer]?.skipTurn) {
                gameState.players[gameState.currentPlayer].skipTurn = false;
                addLog(`${gameState.players[gameState.currentPlayer].name} מדלג על התור`);
            }
            
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            document.getElementById('roll-btn').disabled = false;
            updateDisplay();
        }

        function updateDisplay() {
            if (gameState.players.length === 0) return;
            
            document.getElementById('current-turn').textContent = 
                `תור ${gameState.players[gameState.currentPlayer].name}`;
            
            const playersInfo = document.getElementById('players-info');
            playersInfo.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-info ${index === gameState.currentPlayer ? 'current-player' : ''}`;
                
                const properties = player.properties.map(p => gameState.board[p].name).join(', ');
                
                playerDiv.innerHTML = `
                    <strong>${player.token} ${player.name}</strong><br>
                    כסף: ${player.money} ₪<br>
                    נכסים: ${properties || 'אין'}
                `;
                
                playersInfo.appendChild(playerDiv);
            });
        }

        function addLog(message) {
            const log = document.getElementById('game-log');
            const logEntry = document.createElement('div');
            logEntry.textContent = message;
            logEntry.style.margin = '5px 0';
            logEntry.style.padding = '5px';
            logEntry.style.background = '#f8f9fa';
            logEntry.style.borderRadius = '5px';
            
            log.insertBefore(logEntry, log.firstChild);
            
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function endGame() {
            const winner = gameState.players[0];
            alert(`🏆 ${winner.name} ניצח במשחק עם ${winner.money} ₪! 🏆`);
            
            if (confirm('האם תרצה לשחק שוב?')) {
                location.reload();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            window.onclick = function(event) {
                if (event.target === document.getElementById('card-modal')) {
                    closeCard();
                }
                if (event.target === document.getElementById('buy-modal')) {
                    closeBuyModal();
                }
            }
        });
    </script>
</body>
</html>
